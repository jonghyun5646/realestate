{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}다세대, 연립 - 내집찾아조{% endblock %}

{% block style %}
    <style>
        .info {
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block content %}
    <nav class="nav navbar-expand navbar-dark bg-dark py-2 fw-bold opacity-75">
        <ul class="navbar-nav nav-fill w-100">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'apt' %}">아파트</a></li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'office' %}">오피스텔</a></li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'multi' %}">다세대, 연립</a></li>
        </ul>
    </nav>

    <div id="main">
        <div id="map" style="height: 550px"></div>
    </div>
{% endblock %}

{% block script %}
    <script type="text/javascript"
            src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=95d3f0dfa5561245c1f47d46bc2daa81&libraries=services,clusterer,drawing"></script>
    <script type="text/javascript"
            src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=95d3f0dfa5561245c1f47d46bc2daa81&libraries=clusterer"></script>
    <script>
        let mapContainer = document.getElementById('map');
        let mapOptions = {
            center: new kakao.maps.LatLng(37.4858838, 126.8973216),
            level: 3
        };

        let map = new kakao.maps.Map(mapContainer, mapOptions);

        let mapTypeControl = new kakao.maps.MapTypeControl();

        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

        let zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        let positions = [
            {% for m in mul %}
                {
                    content: "<div class='info'>지번주소 : {{ m.addr }} {{ m.m_domain }}-{{ m.s_domain }}</div>" +
                        "<div class='info'>면적 : {{ m.area }}</div>" +
                        "<div class='info'>층수 : {{ m.floor }}</div>" +
                        "<div class='info'>건축년도 : {{ m.year }}</div>" +
                        "<div>&nbsp;&nbsp;&nbsp;</div>",
                    latlng: new kakao.maps.LatLng({{ m.latitude }}, {{ m.longitude }}),
                    "lat":{{ m.latitude }},
                    "lng":{{ m.longitude }}
                },
            {% endfor %}
        ]

        let imageSrc = '../static/img/icon/villa.png'

        let markers = [];
        for (let i = 0; i < positions.length; i++) {
            let imageSize = new kakao.maps.Size(50, 50);

            let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

            marker = new kakao.maps.Marker({
                map: map,
                position: positions[i].latlng,
                image: markerImage
            });

            let infowindow = new kakao.maps.InfoWindow({
                content: positions[i].content
            });


            // 생성된 마커를 마커 저장하는 변수에 넣음(마커 클러스터러 관련)
            markers.push(marker);

            kakao.maps.event.addListener(marker, 'click', makeOverListener(map, marker, infowindow));
            kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow))
        }

        function makeOverListener(map, marker, infowindow) {
            return function () {
                infowindow.open(map, marker);
            };
        }

        function makeOutListener(infowindow) {
            return function () {
                infowindow.close();
            };
        }

        // 마커 클러스터러를 생성합니다
        let clusterer = new kakao.maps.MarkerClusterer({
            map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체
            averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정
            minLevel: 4 // 클러스터 할 최소 지도 레벨
        });

        // 클러스터러에 마커들을 추가합니다(마커 클러스터러 관련)
        clusterer.addMarkers(markers);
    </script>
{% endblock %}